name: push container (development branch)

on:
  push:
    branches: master
  schedule:
    - cron: "30 9 * * 2,5"
  workflow_dispatch:
    inputs:
        src_ref:
          description: "The branch/tag for which the dispatch is sent from dreambbs project"
          required: true
          default: "refs/heads/develop"
        src_sha:
          description: "The commit SHA for which the dispatch is sent from dreambbs project"
          required: true
          default: ""

jobs:
  main:
    if: "!contains(github.event.head_commit.message, 'skip-ci')"
    runs-on: ubuntu-20.04
    permissions:
      actions: read
      contents: read
      security-events: write
    strategy:
        fail-fast: false
        matrix:
          language: [ 'cpp' ]
    steps:
      -
        name: Get current date
        id: date
        run: echo "::set-output name=date::$(date +'%Y%m%d')"
      -
        name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1
      -
        name: Login to DockerHub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Initializes the CodeQL tools for scanning.
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v1
        with:
          languages: ${{ matrix.language }}

      -
        name: Build and push
        id: docker_build
        uses: docker/build-push-action@v2
        with:
          push: true
          file: ./Dockerfile.develop
          tags: bbsdocker/imagedreambbs:develop,bbsdocker/imagedreambbs:develop-latest,bbsdocker/imagedreambbs:develop-${{ steps.date.outputs.date }}

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v1
        with:
          output: '../results'
          upload: false

      -
        name: Image digest
        run: echo ${{ steps.docker_build.outputs.digest }}
      -
        name : Add Notification in bbs-dev in CCNS Discord
        uses: sarisia/actions-status-discord@v1
        if: always()
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}

      - name: Setting Commit Information from DreamBBS
        run: |
          if [[ -z "$SRC_SHA" ]]; then
            SRC_REF_INFO=$(curl
              -H "Accept: application/vnd.github.v3+json"
              https://api.github.com/repos/ccns/dreambbs/branches/develop)
          fi
          echo "SRC_REF_INFO=$SRC_REF_INFO" >> $GITHUB_ENV
          echo "SRC_SHA=$SRC_SHA" >> $GITHUB_ENV
          echo "SRC_REF=$SRC_REF" >> $GITHUB_ENV
        env:
          SRC_SHA: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.src_sha || 'refs/heads/develop' }}
          SRC_REF: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.src_ref || '' }}

      - name: Upload CodeQL Analysis Results
        run: |
          curl \
          -X POST \
          -u "${{ secrets.PAT_USERNAME }}:${{ secrets.PAT_TOKEN }}" \
          -H "Accept: application/vnd.github.v3+json" \
          https://api.github.com/repos/ccns/dreambbs/code-scanning/sarifs \
          -d '{
            "commit_sha": "'"$SRC_SHA"'",
            "ref": "'"$SRC_REF"'",
            "sarif": "'"$(gzip -c "$SARIF_FILE" | base64 -w0)"'"
          }'
        env:
          SRC_SHA: ${{ env.SRC_SHA || fromJSON(env.SRC_REF_INFO).commit.sha }}
          SARIF_FILE: '../results'
